<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>–°—Ç–æ–ª–∏–∫–∏</title>
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: "Segoe UI", sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .grid {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .card {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 400px;
        }

        .card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .card-content {
            padding: 16px;
            flex-grow: 1;
        }

        .card h2 {
            font-size: 18px;
            margin: 0 0 8px 0;
        }

        .card p {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            margin: 0 0 16px 0;
        }

        .card button {
            margin: 0 16px 16px;
            height: 44px;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .card button:hover {
            opacity: 0.8;
        }
        
        #booking-form-container {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--tg-theme-bg-color);
            opacity: 0.95;
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #booking-form {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 16px;
            padding: 15px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
            position: relative;
            box-sizing: border-box;
        }
        
        #booking-form h2 {
            margin-top: 0;
            color: var(--tg-theme-text-color);
            text-align: center;
        }
        
        #booking-form label {
            display: block;
            margin: 6px 0 3px;
            color: var(--tg-theme-text-color);
        }
        
        #booking-form input,
        #booking-form select {
            width: 100%;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid var(--tg-theme-hint-color);
            background-color: transparent;
            color: var(--tg-theme-text-color);
            font-size: 14px;
            box-shadow: none;
            box-sizing: border-box;
        }
        
        #booking-form input:focus,
        #booking-form select:focus {
            outline: none;
            border: 1px solid var(--tg-theme-link-color);
            box-shadow: none;
        }
        
        #booking-form button[type="submit"] {
            margin-top: 15px;
            padding: 12px;
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            transition: background 0.3s ease;
        }
        
        #booking-form button:disabled {
            background-color: var(--tg-theme-hint-color);
            cursor: not-allowed;
        }
        
        #message {
            margin-top: 15px;
            font-size: 1.1em;
            color: var(--tg-theme-link-color);
            text-align: center;
        }
        
        #closeBookingForm {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 24px;
            color: var(--tg-theme-link-color);
            cursor: pointer;
            user-select: none;
        }
    </style>
</head>
<body>
<h1>üçΩÔ∏è –°—Ç–æ–ª–∏–∫–∏</h1>
<div class="grid">
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 1" /><div class="card-content"><h2>–°—Ç–æ–ª 1</h2><p>–°—Ç–æ–ª–∏–∫ —Å –¥–∏–≤–∞–Ω–æ–º —É –æ–∫–Ω–∞</p></div><button data-table="1">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 2" /><div class="card-content"><h2>–°—Ç–æ–ª 2</h2><p>–£—é—Ç–Ω—ã–π —Å—Ç–æ–ª–∏–∫ –Ω–∞ –¥–≤–æ–∏—Ö</p></div><button data-table="2">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 3" /><div class="card-content"><h2>–°—Ç–æ–ª 3</h2><p>–£ –æ–∫–Ω–∞, –Ω–∞ 4 –ø–µ—Ä—Å–æ–Ω—ã</p></div><button data-table="3">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 4" /><div class="card-content"><h2>–°—Ç–æ–ª 4</h2><p>–†—è–¥–æ–º —Å –±–∞—Ä–Ω–æ–π —Å—Ç–æ–π–∫–æ–π</p></div><button data-table="4">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 5" /><div class="card-content"><h2>–°—Ç–æ–ª 5</h2><p>–°—Ç–æ–ª–∏–∫ —Å –¥–∏–≤–∞–Ω–æ–º</p></div><button data-table="5">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 6" /><div class="card-content"><h2>–°—Ç–æ–ª 6</h2><p>–î–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ 6 —á–µ–ª–æ–≤–µ–∫</p></div><button data-table="6">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 7" /><div class="card-content"><h2>–°—Ç–æ–ª 7</h2><p>–£ –æ–∫–Ω–∞, —Ä—è–¥–æ–º —Å —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏</p></div><button data-table="7">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 8" /><div class="card-content"><h2>–°—Ç–æ–ª 8</h2><p>–í –≥–ª—É–±–∏–Ω–µ –∑–∞–ª–∞</p></div><button data-table="8">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 9" /><div class="card-content"><h2>–°—Ç–æ–ª 9</h2><p>–û–∫—Ä—É–∂—ë–Ω –º—è–≥–∫–∏–º–∏ –∫—Ä–µ—Å–ª–∞–º–∏</p></div><button data-table="9">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
</div>

<div id="booking-form-container">
    <form id="booking-form">
        <div id="closeBookingForm">&times;</div>
        <h2>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∏–∫–∞ <span id="selected-table"></span></h2>
        <label for="date">–î–∞—Ç–∞</label>
        <input type="date" id="date" required />
        <label for="time">–í—Ä–µ–º—è</label>
        <select id="time" required></select>
        <label for="guests">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π</label>
        <input type="number" id="guests" min="1" max="20" value="1" required />
        <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input type="tel" id="phone" placeholder="+7 (999) 123-45-67" required />
        <button type="submit">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω—å</button>
        <div id="message"></div>
    </form>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    // --- –î–ê–ù–ù–´–ï –û –°–¢–û–õ–ê–• (–û–±–Ω–æ–≤–ª–µ–Ω—ã: –µ–¥–∏–Ω–æ–µ —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ç–æ –¥–ª—è –≤—Å–µ—Ö 8 —Å—Ç–æ–ª–æ–≤) ---
const tableData = {
    '1': { 
        name: '–°—Ç–æ–ª–∏–∫ ‚Ññ1 (–£ –ë–∞—Ä–∞)', 
        seats: 2, 
        desc: '–£—é—Ç–Ω—ã–π —Å—Ç–æ–ª–∏–∫ –¥–ª—è –¥–≤–æ–∏—Ö —Å –≤–∏–¥–æ–º –Ω–∞ –±–∞—Ä–Ω—É—é —Å—Ç–æ–π–∫—É. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –∞–ø–µ—Ä–∏—Ç–∏–≤–∞.',
        photo_url: 'https://media.istockphoto.com/id/649672132/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%80%D0%BE%D0%BC%D0%B0%D0%BD%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%B2%D0%B5%D1%87%D0%B5%D1%80.jpg?s=612x612&w=0&k=20&c=WKNImb0RI-7oJy3RoqJhWg-VflxZI82SosEwIV1kssQ='
    },
    '2': { 
        name: '–°—Ç–æ–ª–∏–∫ ‚Ññ2 (–£ –ë–∞—Ä–∞)', 
        seats: 2, 
        desc: '–ù–µ–±–æ–ª—å—à–æ–π –∫—Ä—É–≥–ª—ã–π —Å—Ç–æ–ª –≤–¥–∞–ª–∏ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∑–∞–ª–∞. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Å–≤–∏–¥–∞–Ω–∏–π.',
        photo_url: 'https://media.istockphoto.com/id/649672132/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%80%D0%BE%D0%BC%D0%B0%D0%BD%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%B2%D0%B5%D1%87%D0%B5%D1%80.jpg?s=612x612&w=0&k=20&c=WKNImb0RI-7oJy3RoqJhWg-VflxZI82SosEwIV1kssQ='
    },
    '3': { 
        name: '–ë–∞–Ω–∫–µ—Ç–∫–∞ ‚Ññ3 (–£ –°—Ç–µ–Ω—ã)', 
        seats: 4, 
        desc: '–ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π –¥–∏–≤–∞–Ω –Ω–∞ —á–µ—Ç—ã—Ä–µ—Ö —á–µ–ª–æ–≤–µ–∫. –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω —É —Å—Ç–µ–Ω—ã –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏.',
        photo_url: 'https://media.istockphoto.com/id/649672132/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%80%D0%BE%D0%BC%D0%B0%D0%BD%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%B2%D0%B5%D1%87%D0%B5%D1%80.jpg?s=612x612&w=0&k=20&c=WKNImb0RI-7oJy3RoqJhWg-VflxZI82SosEwIV1kssQ='
    },
    '4': { 
        name: '–ë–∞–Ω–∫–µ—Ç–∫–∞ ‚Ññ4 (–£ –°—Ç–µ–Ω—ã)', 
        seats: 4, 
        desc: '–£–¥–æ–±–Ω–∞—è –±–∞–Ω–∫–µ—Ç–∫–∞ —Å –º—è–≥–∫–∏–º–∏ —Å–∏–¥–µ–Ω—å—è–º–∏. –û—Ç–ª–∏—á–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è —Å–µ–º–µ–π–Ω–æ–≥–æ —É–∂–∏–Ω–∞.',
        photo_url: 'https://media.istockphoto.com/id/649672132/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%80%D0%BE%D0%BC%D0%B0%D0%BD%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%B2%D0%B5%D1%87%D0%B5%D1%80.jpg?s=612x612&w=0&k=20&c=WKNImb0RI-7oJy3RoqJhWg-VflxZI82SosEwIV1kssQ='
    },
    '5': { 
        name: '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –°—Ç–æ–ª ‚Ññ5', 
        seats: 6, 
        desc: '–ë–æ–ª—å—à–æ–π –∫—Ä—É–≥–ª—ã–π —Å—Ç–æ–ª –≤ —Ü–µ–Ω—Ç—Ä–µ –∑–∞–ª–∞. –ò–¥–µ–∞–ª–µ–Ω –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫–æ–º–ø–∞–Ω–∏–π –∏ —Ç–æ—Ä–∂–µ—Å—Ç–≤.',
        photo_url: 'https://media.istockphoto.com/id/649672132/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%80%D0%BE%D0%BC%D0%B0%D0%BD%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%B2%D0%B5%D1%87%D0%B5%D1%80.jpg?s=612x612&w=0&k=20&c=WKNImb0RI-7oJy3RoqJhWg-VflxZI82SosEwIV1kssQ='
    },
    '6': { 
        name: '–°—Ç–æ–ª ‚Ññ6 (–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–π)', 
        seats: 8, 
        desc: '–°–∞–º—ã–π –±–æ–ª—å—à–æ–π —Å—Ç–æ–ª –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á.',
        photo_url: 'https://media.istockphoto.com/id/649672132/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%80%D0%BE%D0%BC%D0%B0%D0%BD%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%B2%D0%B5%D1%87%D0%B5%D1%80.jpg?s=612x612&w=0&k=20&c=WKNImb0RI-7oJy3RoqJhWg-VflxZI82SosEwIV1kssQ='
    },
    '7': { 
        name: '–°—Ç–æ–ª ‚Ññ7 (–£ –í—Ö–æ–¥–∞)', 
        seats: 4, 
        desc: '–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–π —Å—Ç–æ–ª–∏–∫, –±–ª–∏–∑–∫–æ –∫ –≤—Ö–æ–¥—É. –•–æ—Ä–æ—à–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±–µ–¥–∞.',
        photo_url: 'https://media.istockphoto.com/id/649672132/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%80%D0%BE%D0%BC%D0%B0%D0%BD%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%B2%D0%B5%D1%87%D0%B5%D1%80.jpg?s=612x612&w=0&k=20&c=WKNImb0RI-7oJy3RoqJhWg-VflxZI82SosEwIV1kssQ='
    },
    '8': { 
        name: '–°—Ç–æ–ª ‚Ññ8 (–£ –í—Ö–æ–¥–∞)', 
        seats: 4, 
        desc: '–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–π —Å—Ç–æ–ª —Å —Ö–æ—Ä–æ—à–∏–º –æ–±–∑–æ—Ä–æ–º –Ω–∞ –≤—Ö–æ–¥–Ω—É—é –≥—Ä—É–ø–ø—É.',
        photo_url: 'https://media.istockphoto.com/id/649672132/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%80%D0%BE%D0%BC%D0%B0%D0%BD%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%B2%D0%B5%D1%87%D0%B5%D1%80.jpg?s=612x612&w=0&k=20&c=WKNImb0RI-7oJy3RoqJhWg-VflxZI82SosEwIV1kssQ='
    }
};


    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ DOM —ç–ª–µ–º–µ–Ω—Ç—ã ---
    let user_id = null;
    let user_name = null;
    let botApiUrl = '';
    let selectedTable = null;
    // –ù–æ–≤–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è: –∫—ç—à –∑–∞–Ω—è—Ç—ã—Ö –≤—Ä–µ–º–µ–Ω –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–∞ –Ω–∞ —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
    let bookedTimesCache = {}; 
    
    const dateInputModal = document.getElementById("date-modal");
    const timeSelectModal = document.getElementById("time-modal");
    const guestsInputModal = document.getElementById("guests-modal");
    const phoneInputModal = document.getElementById("phone-modal");
    const confirmBtn = document.getElementById("confirm-btn");
    const bookingOverlay = document.getElementById("booking-overlay");
    const bookingForm = document.getElementById("booking-form");
    const messageDiv = document.getElementById("message");
    
    const dateValueDisplay = document.getElementById("current-date-value");
    const timeValueDisplay = document.getElementById("current-time-value");
    const guestsValueDisplay = document.getElementById("current-guests-value");

    const tableDetailsCard = document.getElementById("table-details-card");
    const tablePhoto = document.getElementById("table-photo");
    const tableTitle = document.getElementById("table-title");
    const tableDescription = document.getElementById("table-description");


    function getQueryParams() {
        const params = {};
        new URLSearchParams(window.location.search).forEach((value, key) => {
            params[key] = value;
        });
        return params;
    }

    function adaptToTheme() {
        document.documentElement.style.setProperty('color-scheme', 'dark');
    }

    window.onload = async function() {
        const params = getQueryParams();
        user_id = params.user_id;
        user_name = params.user_name;
        botApiUrl = params.bot_url || "https://readytoearn-4.onrender.com"; 

        if (window.Telegram && window.Telegram.WebApp) {
            adaptToTheme();
            window.Telegram.WebApp.ready();
        }
        
        const now = new Date();
        const todayStr = now.toISOString().slice(0, 10);
        
        dateInputModal.value = todayStr;
        dateValueDisplay.textContent = formatDateForDisplay(now);
        guestsValueDisplay.textContent = guestsInputModal.value;

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Ä–µ–º—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        await fetchAndCacheBookedTables(todayStr); // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∑–∞–Ω—è—Ç—ã–µ –≤—Ä–µ–º–µ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö —Å—Ç–æ–ª–æ–≤
        fillTimeSelect(null, todayStr); // –ó–∞–ø–æ–ª–Ω—è–µ–º select –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å—Ç–æ–ª—É
        updateTableAvailability(todayStr, timeSelectModal.value); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
    };

    function formatDateForDisplay(date) {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);

        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–∞—Ç—É –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        const targetDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const todayNormalized = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const tomorrowNormalized = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate());

        if (targetDate.getTime() === todayNormalized.getTime()) {
            return "–°–µ–≥–æ–¥–Ω—è, " + date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        } else if (targetDate.getTime() === tomorrowNormalized.getTime()) {
            return "–ó–∞–≤—Ç—Ä–∞, " + date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        } else {
            return date.toLocaleDateString('ru-RU', { weekday: 'short', day: 'numeric', month: 'short' });
        }
    }

    function generateAllTimeSlots() {
        const slots = [];
        let start = new Date(); start.setHours(12, 0, 0, 0); 
        const end = new Date(); end.setHours(23, 0, 0, 0); 
        while (start <= end) {
            slots.push(start.toTimeString().slice(0, 5));
            start = new Date(start.getTime() + 30 * 60000);
        }
        return slots;
    }

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –∫—ç—à–∏—Ä—É–µ—Ç –≤—Å–µ –∑–∞–Ω—è—Ç—ã–µ –≤—Ä–µ–º–µ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö —Å—Ç–æ–ª–æ–≤ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É.
     * @param {string} selectedDate - –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD.
     */
    async function fetchAndCacheBookedTables(selectedDate) {
        bookedTimesCache = {}; // –û—á–∏—â–∞–µ–º –∫—ç—à –¥–ª—è –Ω–æ–≤–æ–π –¥–∞—Ç—ã
        const tableIds = Object.keys(tableData);
        const fetches = tableIds.map(tableId => {
            const url = `${botApiUrl}/get_booked_times?table=${tableId}&date=${selectedDate}`;
            return fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok') {
                        bookedTimesCache[tableId] = data.booked_times;
                    } else {
                        bookedTimesCache[tableId] = [];
                    }
                })
                .catch(error => {
                    console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–Ω—è—Ç—ã—Ö –≤—Ä–µ–º–µ–Ω –¥–ª—è —Å—Ç–æ–ª–∞ ${tableId}:`, error);
                    bookedTimesCache[tableId] = []; // –°—á–∏—Ç–∞–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–º–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                });
        });
        await Promise.all(fetches);
    }


    function fillTimeSelect(tableId, selectedDate) {
        const select = timeSelectModal;
        select.innerHTML = '';
        
        const allSlots = generateAllTimeSlots();
        let firstAvailableSlot = null;
        
        const now = new Date();
        const todayDateStr = now.toISOString().slice(0, 10);

        allSlots.forEach(slot => {
            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Å—Ç–æ–ª, –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ –∑–∞–Ω—è—Ç–æ—Å—Ç—å –≤ –∫—ç—à–µ.
            // –ï—Å–ª–∏ —Å—Ç–æ–ª –Ω–µ –≤—ã–±—Ä–∞–Ω (tableId == null), —Å–ª–æ—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–º
            // –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏.
            let isBooked = false;
            if (tableId && bookedTimesCache[tableId]) {
                isBooked = bookedTimesCache[tableId].includes(slot);
            }
            
            let isPast = false;
            if (selectedDate === todayDateStr) {
                const [h, m] = slot.split(':').map(Number);
                const slotTime = new Date();
                slotTime.setHours(h, m, 0, 0);
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –±—É—Ñ–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15 –º–∏–Ω—É—Ç)
                if (slotTime.getTime() <= now.getTime() + 15 * 60000) { 
                    isPast = true;
                }
            }
            
            if (!isBooked && !isPast) {
                const option = document.createElement("option");
                option.value = slot;
                option.textContent = slot;
                select.appendChild(option);
                
                if (!firstAvailableSlot) {
                    firstAvailableSlot = slot;
                }
            }
        });
        
        select.disabled = select.options.length === 0;
        if (select.options.length > 0) {
            select.value = timeValueDisplay.textContent || firstAvailableSlot;
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –≤—Ä–µ–º—è –≤ UI, –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –µ—â–µ –Ω–µ—Ç
            if (!timeValueDisplay.textContent || !select.value) {
                 timeValueDisplay.textContent = firstAvailableSlot;
            } else {
                 timeValueDisplay.textContent = select.value;
            }
        } else {
            timeValueDisplay.textContent = "–ù–µ—Ç –º–µ—Å—Ç";
        }
    }
    
    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–æ–ª–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ
     * –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –∫—ç—à–∞ –∑–∞–Ω—è—Ç—ã—Ö —Å—Ç–æ–ª–æ–≤.
     * @param {string} date - –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ (YYYY-MM-DD).
     * @param {string} time - –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è (HH:MM).
     */
    function updateTableAvailability(date, time) {
        
        document.querySelectorAll('.table-element').forEach(table => {
            table.classList.remove('table-booked', 'table-selected');
        });
        
        if (!time || time === "–ù–µ—Ç –º–µ—Å—Ç") {
             document.querySelectorAll('.table-element').forEach(table => {
                 table.classList.add('table-booked'); // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ —Å—Ç–æ–ª—ã, –µ—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
             });
             confirmBtn.disabled = true;
             confirmBtn.textContent = '–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏';
             return;
        }

        // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å—Ç–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–Ω—è—Ç—ã –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
        Object.keys(tableData).forEach(tableId => {
            const tableElement = document.getElementById(`table-${tableId}`);
            if (tableElement) {
                 const bookedTimes = bookedTimesCache[tableId] || [];
                 if (bookedTimes.includes(time)) {
                     tableElement.classList.add('table-booked');
                 }
            }
        });

        // 4. –õ–æ–≥–∏–∫–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ç–æ–ª–∞
        if (selectedTable) {
            const tableElement = document.getElementById(`table-${selectedTable}`);
            if (tableElement && tableElement.classList.contains('table-booked')) {
                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–æ–ª –æ–∫–∞–∑–∞–ª—Å—è –∑–∞–Ω—è—Ç –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                selectedTable = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
                confirmBtn.disabled = true;
                confirmBtn.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Å—Ç–æ–ª';
                tableDetailsCard.style.display = 'none';
                messageDiv.textContent = '‚ùå –í–∞—à —Å—Ç–æ–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–Ω—è–ª–∏. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π.';
                messageDiv.style.display = 'block';
            } else if (tableElement) {
                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–æ–ª —Å–≤–æ–±–æ–¥–µ–Ω
                tableElement.classList.add('table-selected');
                confirmBtn.disabled = false;
                confirmBtn.textContent = `–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª ${selectedTable}`;
                showTableDetails(selectedTable);
                messageDiv.style.display = 'none';
            }
        } else {
            confirmBtn.disabled = true;
            confirmBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω—å';
            tableDetailsCard.style.display = 'none';
            messageDiv.style.display = 'none';
        }
    }

    function showTableDetails(tableId) {
        const data = tableData[tableId];
        if (data) {
            tablePhoto.src = data.photo_url;
            tableTitle.textContent = data.name;
            tableDescription.innerHTML = `<strong>–ú–µ—Å—Ç:</strong> ${data.seats}<br>${data.desc}`;
            tableDetailsCard.style.display = 'block';
        }
    }

    document.querySelectorAll('.table-element').forEach(table => {
        table.addEventListener('click', (e) => {
            const clickedTable = e.currentTarget.dataset.table;
            
            if (e.currentTarget.classList.contains('table-booked')) {
                messageDiv.textContent = '‚ùå –°—Ç–æ–ª–∏–∫ –∑–∞–Ω—è—Ç. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π.';
                messageDiv.style.display = 'block';
                return;
            }
            
            if (selectedTable) {
                document.getElementById(`table-${selectedTable}`).classList.remove('table-selected');
            }
            
            selectedTable = clickedTable;
            e.currentTarget.classList.add('table-selected');
            confirmBtn.disabled = false;
            confirmBtn.textContent = `–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª ${selectedTable}`;
            messageDiv.style.display = 'none';

            showTableDetails(selectedTable);
        });
    });

    confirmBtn.addEventListener('click', () => {
        if (!selectedTable) return;
        
        document.getElementById('selected-table-modal').textContent = selectedTable;
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º
        dateInputModal.value = dateInputModal.value; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞—Ç—É
        guestsInputModal.value = guestsInputModal.value; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–æ—Å—Ç–µ–π
        fillTimeSelect(selectedTable, dateInputModal.value); // –ü–µ—Ä–µ–∑–∞–ø–æ–ª–Ω—è–µ–º –≤—Ä–µ–º—è —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å—Ç–æ–ª—É
        timeSelectModal.value = timeValueDisplay.textContent; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è

        phoneInputModal.value = ''; 
        bookingOverlay.style.display = 'flex';
    });

    document.getElementById("closeBookingForm").addEventListener('click', () => {
        bookingOverlay.style.display = 'none';
    });

    dateInputModal.addEventListener('change', async (e) => {
        const newDate = new Date(e.target.value);
        dateValueDisplay.textContent = formatDateForDisplay(newDate);
        await fetchAndCacheBookedTables(e.target.value); // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–∞—Ç—ã
        fillTimeSelect(null, e.target.value); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ-–Ω–æ–≤–æ–º—É
        updateTableAvailability(e.target.value, timeSelectModal.value); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
    });

    timeSelectModal.addEventListener('change', (e) => {
        timeValueDisplay.textContent = e.target.value;
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É, –Ω–æ *–Ω–µ* –¥–µ–ª–∞–µ–º —Å–µ—Ç–µ–≤–æ–π –∑–∞–ø—Ä–æ—Å, –∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à
        updateTableAvailability(dateInputModal.value, e.target.value); 
    });

    guestsInputModal.addEventListener('change', (e) => {
        guestsValueDisplay.textContent = e.target.value;
    });


    bookingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        messageDiv.textContent = "";
        messageDiv.style.display = "none";
        
        const selectedDateTime = new Date(`${dateInputModal.value}T${timeSelectModal.value}:00`);
        const now = new Date();
        
        if (selectedDateTime < now) {
            messageDiv.textContent = "‚ùå –ù–µ–ª—å–∑—è –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è";
            messageDiv.style.display = "block";
            return;
        }
        
        const data = {
            user_id: user_id,
            user_name: user_name,
            table: selectedTable,
            date: dateInputModal.value,
            time: timeSelectModal.value,
            guests: guestsInputModal.value,
            phone: phoneInputModal.value
        };

        try {
            const res = await fetch(`${botApiUrl}/book`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            
            if (res.ok) {
                messageDiv.textContent = "‚úÖ –°—Ç–æ–ª–∏–∫ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω! –ò—â–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ Telegram.";
                window.Telegram.WebApp.sendData(JSON.stringify(data));
                
                // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–≠–®–ê –ò UI –ü–û–°–õ–ï –£–°–ü–ï–®–ù–û–ì–û –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø
                // 1. –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –≤ –∫—ç—à
                if (!bookedTimesCache[selectedTable]) {
                     bookedTimesCache[selectedTable] = [];
                }
                bookedTimesCache[selectedTable].push(timeSelectModal.value);

                setTimeout(() => {
                    bookingOverlay.style.display = "none";
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–æ–ª
                    document.getElementById(`table-${selectedTable}`).classList.remove('table-selected');
                    selectedTable = null;
                    
                    confirmBtn.disabled = true;
                    confirmBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω—å';
                    tableDetailsCard.style.display = 'none'; 
                    messageDiv.style.display = 'none';

                    // 2. –í–∏–∑—É–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–æ–ª –∑–∞–Ω—è—Ç—ã–º
                    updateTableAvailability(dateInputModal.value, timeSelectModal.value);
                }, 2000);

            } else {
                messageDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å'}`;
            }
            messageDiv.style.display = "block";
        } catch (err) {
            console.error('Fetch error:', err);
            messageDiv.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.";
            messageDiv.style.display = "block";
        }
    });
</script>
</body>
</html>