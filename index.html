<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />
<title>–°—Ç–æ–ª–∏–∫–∏</title>
<style>
:root { color-scheme: dark; }
body { margin: 0; padding: 20px; font-family: "Segoe UI", sans-serif; background-color: var(--tg-theme-bg-color, #1f1f1f); color: var(--tg-theme-text-color, #ffffff); box-sizing: border-box; }
h1 { font-size: 24px; font-weight: bold; margin-bottom: 20px; text-align: center; }
.grid { display: flex; flex-direction: column; align-items: center; gap: 16px; }
.card { background-color: var(--tg-theme-secondary-bg-color, #252525); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; width: 100%; max-width: 400px; }
.card img { width: 100%; height: 150px; object-fit: cover; }
.card-content { padding: 16px; flex-grow: 1; }
.card h2 { font-size: 18px; margin: 0 0 8px 0; }
.card p { font-size: 14px; color: var(--tg-theme-hint-color, #aaaaaa); margin: 0 0 16px 0; }
.card button { margin: 0 16px 16px; height: 44px; background-color: #007bff; color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer; transition: background 0.3s ease; }
.card button:hover { background-color: #0056b3; }
#booking-form-container { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); justify-content: center; align-items: center; padding: 20px; }
#booking-form { background-color: var(--tg-theme-secondary-bg-color, #252525); border-radius: 16px; padding: 20px; width: 90%; max-width: 400px; box-shadow: 0 0 15px rgba(0, 123, 255, 0.5); position: relative; box-sizing: border-box; }
#booking-form h2 { margin-top: 0; color: white; text-align: center; }
#booking-form label { display: block; margin: 8px 0 4px; color: white; }
#booking-form input, #booking-form select { width: 100%; padding: 8px; border-radius: 8px; border: none; background-color: transparent; color: #eee; font-size: 16px; box-shadow: none; box-sizing: border-box; border: 1px solid #555; }
#booking-form input:focus, #booking-form select:focus { outline: none; border: 1px solid #28a745; box-shadow: none; }
#booking-form button { margin-top: 20px; padding: 14px; background: #28a745; color: white; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; width: 100%; transition: background 0.3s ease; }
#booking-form button:hover:not(:disabled) { background: #1e7e34; }
#booking-form button:disabled { background: #155d27; cursor: not-allowed; }
#message { margin-top: 15px; font-size: 1.1em; color: #aaffff; text-align: center; }
#closeBookingForm { position: absolute; top: 12px; right: 16px; font-size: 24px; color: #28a745; cursor: pointer; user-select: none; }
</style>
</head>
<body>
<h1>üçΩÔ∏è –°—Ç–æ–ª–∏–∫–∏</h1>
<div class="grid">
¬† <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 1" /><div class="card-content"><h2>–°—Ç–æ–ª 1</h2><p>–°—Ç–æ–ª–∏–∫ —Å –¥–∏–≤–∞–Ω–æ–º —É –æ–∫–Ω–∞</p></div><button data-table="1">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
¬† <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 2" /><div class="card-content"><h2>–°—Ç–æ–ª 2</h2><p>–£—é—Ç–Ω—ã–π —Å—Ç–æ–ª–∏–∫ –Ω–∞ –¥–≤–æ–∏—Ö</p></div><button data-table="2">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
¬† <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 3" /><div class="card-content"><h2>–°—Ç–æ–ª 3</h2><p>–£ –æ–∫–Ω–∞, –Ω–∞ 4 –ø–µ—Ä—Å–æ–Ω—ã</p></div><button data-table="3">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
¬† <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 4" /><div class="card-content"><h2>–°—Ç–æ–ª 4</h2><p>–†—è–¥–æ–º —Å –±–∞—Ä–Ω–æ–π —Å—Ç–æ–π–∫–æ–π</p></div><button data-table="4">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
¬† <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 5" /><div class="card-content"><h2>–°—Ç–æ–ª 5</h2><p>–°—Ç–æ–ª–∏–∫ —Å –¥–∏–≤–∞–Ω–æ–º</p></div><button data-table="5">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
¬† <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 6" /><div class="card-content"><h2>–°—Ç–æ–ª 6</h2><p>–î–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ 6 —á–µ–ª–æ–≤–µ–∫</p></div><button data-table="6">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
¬† <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 7" /><div class="card-content"><h2>–°—Ç–æ–ª 7</h2><p>–£ –æ–∫–Ω–∞, —Ä—è–¥–æ–º —Å —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏</p></div><button data-table="7">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
¬† <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 8" /><div class="card-content"><h2>–°—Ç–æ–ª 8</h2><p>–í –≥–ª—É–±–∏–Ω–µ –∑–∞–ª–∞</p></div><button data-table="8">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
¬† <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 9" /><div class="card-content"><h2>–°—Ç–æ–ª 9</h2><p>–û–∫—Ä—É–∂—ë–Ω –º—è–≥–∫–∏–º–∏ –∫—Ä–µ—Å–ª–∞–º–∏</p></div><button data-table="9">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
</div>

<div id="booking-form-container">
¬† <form id="booking-form">
¬† ¬† <div id="closeBookingForm">&times;</div>
¬† ¬† <h2>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∏–∫–∞ <span id="selected-table"></span></h2>
¬† ¬† <label for="date">–î–∞—Ç–∞</label>
¬† ¬† <input type="date" id="date" required />
¬† ¬† <label for="time">–í—Ä–µ–º—è</label>
¬† ¬† <select id="time" required></select>
¬† ¬† <label for="guests">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π</label>
¬† ¬† <input type="number" id="guests" min="1" max="20" value="1" required />
¬† ¬† <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
¬† ¬† <input type="tel" id="phone" placeholder="+7 (999) 123-45-67" required />
¬† ¬† <button type="submit">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω—å</button>
¬† ¬† <div id="message"></div>
¬† </form>
</div>

<script src="https://telegram.org/js/telegram-web-app.js?59"></script>
<script>
    // URL –≤–∞—à–µ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ Render
    const RENDER_URL = "https://readytoearn-4.onrender.com";

    // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã
    function generateAllTimeSlots() {
        const slots = [];
        let start = new Date(); start.setHours(12, 0, 0, 0);
        const end = new Date(); end.setHours(23, 0, 0, 0);
        while (start <= end) {
            slots.push(start.toTimeString().slice(0, 5));
            start = new Date(start.getTime() + 30 * 60000);
        }
        return slots;
    }

    // üÜï –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
    async function fillTimeSelect(selectedTable, selectedDate) {
        const select = document.getElementById("time");
        select.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–ª–æ—Ç—ã
        const allSlots = generateAllTimeSlots();

        // –ü–æ–ª—É—á–∞–µ–º –∑–∞–Ω—è—Ç—ã–µ —Å–ª–æ—Ç—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
        let bookedTimes = [];
        try {
            const url = `${RENDER_URL}/get_booked_times?table=${selectedTable}&date=${selectedDate}`;
            const res = await fetch(url);
            const data = await res.json();
            if (data.status === 'ok') {
                bookedTimes = data.booked_times;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–Ω—è—Ç—ã—Ö –≤—Ä–µ–º–µ–Ω:', error);
        }

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ —Å–ª–æ—Ç–∞–º–∏
        allSlots.forEach(slot => {
            // –ï—Å–ª–∏ —Å–ª–æ—Ç –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ –∑–∞–Ω—è—Ç—ã—Ö
            if (!bookedTimes.includes(slot)) {
                const option = document.createElement("option");
                option.value = slot;
                option.textContent = slot;
                select.appendChild(option);
            }
        });
    }

    const bookingContainer = document.getElementById("booking-form-container");
    const bookingForm = document.getElementById("booking-form");
    const selectedTableSpan = document.getElementById("selected-table");
    const dateInput = document.getElementById("date");
    let selectedTable = null;

    // üÜï –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å—Ç–æ–ª–∞
    document.querySelectorAll('.card button').forEach(btn => {
        btn.addEventListener('click', () => {
            selectedTable = btn.dataset.table;
            selectedTableSpan.textContent = selectedTable;
            bookingContainer.style.display = "flex";
            const today = new Date().toISOString().slice(0, 10);
            dateInput.value = today;
            document.getElementById("message").textContent = "";
            
            // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ç–æ–ª–∞ –∏ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
            fillTimeSelect(selectedTable, today);
        });
    });

    // üÜï –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã
    dateInput.addEventListener('change', (e) => {
        const selectedDate = e.target.value;
        if (selectedTable) {
            fillTimeSelect(selectedTable, selectedDate);
        }
    });

    document.getElementById("closeBookingForm").addEventListener('click', () => {
        bookingContainer.style.display = "none";
    });

    bookingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const timeInput = document.getElementById("time");
        const guestsInput = document.getElementById("guests");
        const phoneInput = document.getElementById("phone");
        const messageDiv = document.getElementById("message");

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã
        const today = new Date();
        const selectedDate = new Date(dateInput.value);
        selectedDate.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);
        if (selectedDate < today) {
            messageDiv.textContent = "‚ùå –ù–µ–ª—å–∑—è –≤—ã–±—Ä–∞—Ç—å –ø—Ä–æ—à–ª—É—é –¥–∞—Ç—É";
            return;
        }

        let userId = null;
        let userName = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
            const user = window.Telegram.WebApp.initDataUnsafe.user;
            if (user) {
                userId = user.id;
                userName = `${user.first_name || ''} ${user.last_name || ''}`.trim();
            }
        }
        
        const data = {
            user_id: userId,
            user_name: userName,
            table: selectedTable,
            date: dateInput.value,
            time: timeInput.value,
            guests: guestsInput.value,
            phone: phoneInput.value
        };
        
        console.log(data);
        try {
            const res = await fetch(`${RENDER_URL}/book`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (res.ok) {
                messageDiv.textContent = "‚úÖ –°—Ç–æ–ª–∏–∫ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω";
                bookingForm.reset();
                setTimeout(() => { bookingContainer.style.display = "none"; }, 2000);
            } else {
                messageDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å'}`;
            }
        } catch (err) {
            console.error('Fetch error:', err);
            messageDiv.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.";
        }
    });
</script>
</body>
</html>