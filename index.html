<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>–°—Ç–æ–ª–∏–∫–∏</title>
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: "Segoe UI", sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .grid {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .card {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 400px;
        }

        .card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .card-content {
            padding: 16px;
            flex-grow: 1;
        }

        .card h2 {
            font-size: 18px;
            margin: 0 0 8px 0;
        }

        .card p {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            margin: 0 0 16px 0;
        }

        .card button {
            margin: 0 16px 16px;
            height: 44px;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .card button:hover {
            opacity: 0.8;
        }
        
        #booking-form-container {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--tg-theme-bg-color);
            opacity: 0.95;
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #booking-form {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 16px;
            padding: 15px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
            position: relative;
            box-sizing: border-box;
        }
        
        #booking-form h2 {
            margin-top: 0;
            color: var(--tg-theme-text-color);
            text-align: center;
        }
        
        #booking-form label {
            display: block;
            margin: 6px 0 3px;
            color: var(--tg-theme-text-color);
        }
        
        #booking-form input,
        #booking-form select {
            width: 100%;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid var(--tg-theme-hint-color);
            background-color: transparent;
            color: var(--tg-theme-text-color);
            font-size: 14px;
            box-shadow: none;
            box-sizing: border-box;
        }
        
        #booking-form input:focus,
        #booking-form select:focus {
            outline: none;
            border: 1px solid var(--tg-theme-link-color);
            box-shadow: none;
        }
        
        #booking-form button[type="submit"] {
            margin-top: 15px;
            padding: 12px;
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            transition: background 0.3s ease;
        }
        
        #booking-form button:disabled {
            background-color: var(--tg-theme-hint-color);
            cursor: not-allowed;
        }
        
        #message {
            margin-top: 15px;
            font-size: 1.1em;
            color: var(--tg-theme-link-color);
            text-align: center;
        }
        
        #closeBookingForm {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 24px;
            color: var(--tg-theme-link-color);
            cursor: pointer;
            user-select: none;
        }
    </style>
</head>
<body>
<h1>üçΩÔ∏è –°—Ç–æ–ª–∏–∫–∏</h1>
<div class="grid">
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 1" /><div class="card-content"><h2>–°—Ç–æ–ª 1</h2><p>–°—Ç–æ–ª–∏–∫ —Å –¥–∏–≤–∞–Ω–æ–º —É –æ–∫–Ω–∞</p></div><button data-table="1">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 2" /><div class="card-content"><h2>–°—Ç–æ–ª 2</h2><p>–£—é—Ç–Ω—ã–π —Å—Ç–æ–ª–∏–∫ –Ω–∞ –¥–≤–æ–∏—Ö</p></div><button data-table="2">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 3" /><div class="card-content"><h2>–°—Ç–æ–ª 3</h2><p>–£ –æ–∫–Ω–∞, –Ω–∞ 4 –ø–µ—Ä—Å–æ–Ω—ã</p></div><button data-table="3">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 4" /><div class="card-content"><h2>–°—Ç–æ–ª 4</h2><p>–†—è–¥–æ–º —Å –±–∞—Ä–Ω–æ–π —Å—Ç–æ–π–∫–æ–π</p></div><button data-table="4">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 5" /><div class="card-content"><h2>–°—Ç–æ–ª 5</h2><p>–°—Ç–æ–ª–∏–∫ —Å –¥–∏–≤–∞–Ω–æ–º</p></div><button data-table="5">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 6" /><div class="card-content"><h2>–°—Ç–æ–ª 6</h2><p>–î–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ 6 —á–µ–ª–æ–≤–µ–∫</p></div><button data-table="6">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 7" /><div class="card-content"><h2>–°—Ç–æ–ª 7</h2><p>–£ –æ–∫–Ω–∞, —Ä—è–¥–æ–º —Å —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏</p></div><button data-table="7">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 8" /><div class="card-content"><h2>–°—Ç–æ–ª 8</h2><p>–í –≥–ª—É–±–∏–Ω–µ –∑–∞–ª–∞</p></div><button data-table="8">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    <div class="card"><img src="/images/tabel1.jpg" alt="–°—Ç–æ–ª 9" /><div class="card-content"><h2>–°—Ç–æ–ª 9</h2><p>–û–∫—Ä—É–∂—ë–Ω –º—è–≥–∫–∏–º–∏ –∫—Ä–µ—Å–ª–∞–º–∏</p></div><button data-table="9">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
</div>

<div id="booking-form-container">
    <form id="booking-form">
        <div id="closeBookingForm">&times;</div>
        <h2>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∏–∫–∞ <span id="selected-table"></span></h2>
        <label for="date">–î–∞—Ç–∞</label>
        <input type="date" id="date" required />
        <label for="time">–í—Ä–µ–º—è</label>
        <select id="time" required></select>
        <label for="guests">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π</label>
        <input type="number" id="guests" min="1" max="20" value="1" required />
        <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input type="tel" id="phone" placeholder="+7 (999) 123-45-67" required />
        <button type="submit">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω—å</button>
        <div id="message"></div>
    </form>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    let user_id = null;
    let user_name = null;
    let botApiUrl = '';

    function getQueryParams() {
        const params = {};
        new URLSearchParams(window.location.search).forEach((value, key) => {
            params[key] = value;
        });
        return params;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ —Ü–≤–µ—Ç–æ–≤
    function adaptToTheme() {
        const themeParams = window.Telegram.WebApp.themeParams;
        if (themeParams) {
            document.documentElement.style.setProperty('--tg-theme-bg-color', themeParams.bg_color || '#1f1f1f');
            document.documentElement.style.setProperty('--tg-theme-text-color', themeParams.text_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color || '#252525');
            document.documentElement.style.setProperty('--tg-theme-hint-color', themeParams.hint_color || '#aaaaaa');
            document.documentElement.style.setProperty('--tg-theme-link-color', themeParams.link_color || '#007bff');
            document.documentElement.style.setProperty('--tg-theme-button-color', themeParams.button_color || '#007bff');
            document.documentElement.style.setProperty('--tg-theme-button-text-color', themeParams.button_text_color || '#ffffff');
        }
    }
    
    window.onload = function() {
        const params = getQueryParams();
        user_id = params.user_id;
        user_name = params.user_name;
        botApiUrl = params.bot_url;

        if (!botApiUrl) {
            botApiUrl = "https://readytoearn-4.onrender.com";
        }
        
        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (window.Telegram && window.Telegram.WebApp) {
            adaptToTheme();
        }
    };

    // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.onEvent('themeChanged', adaptToTheme);
        window.Telegram.WebApp.ready();
    }

    function generateAllTimeSlots() {
        const slots = [];
        let start = new Date(); start.setHours(12, 0, 0, 0);
        const end = new Date(); end.setHours(23, 0, 0, 0);
        while (start <= end) {
            slots.push(start.toTimeString().slice(0, 5));
            start = new Date(start.getTime() + 30 * 60000);
        }
        return slots;
    }

    async function fillTimeSelect(selectedTable, selectedDate) {
        const select = document.getElementById("time");
        select.innerHTML = '';
        
        const allSlots = generateAllTimeSlots();

        let bookedTimes = [];
        try {
            const url = `${botApiUrl}/get_booked_times?table=${selectedTable}&date=${selectedDate}`;
            const res = await fetch(url);
            const data = await res.json();
            if (data.status === 'ok') {
                bookedTimes = data.booked_times;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–Ω—è—Ç—ã—Ö –≤—Ä–µ–º–µ–Ω:', error);
        }

        const now = new Date();
        const todayDateStr = now.toISOString().slice(0, 10);

        allSlots.forEach(slot => {
            if (!bookedTimes.includes(slot)) {
                if (selectedDate === todayDateStr) {
                    const slotTime = new Date(`${selectedDate}T${slot}:00`);
                    if (slotTime < now) {
                        return;
                    }
                }

                const option = document.createElement("option");
                option.value = slot;
                option.textContent = slot;
                select.appendChild(option);
            }
        });
    }

    const bookingContainer = document.getElementById("booking-form-container");
    const bookingForm = document.getElementById("booking-form");
    const selectedTableSpan = document.getElementById("selected-table");
    const dateInput = document.getElementById("date");
    let selectedTable = null;

    document.querySelectorAll('.card button').forEach(btn => {
        btn.addEventListener('click', () => {
            selectedTable = btn.dataset.table;
            selectedTableSpan.textContent = selectedTable;
            bookingContainer.style.display = "flex";
            const today = new Date().toISOString().slice(0, 10);
            dateInput.value = today;
            document.getElementById("message").textContent = "";
            document.getElementById("message").style.display = "none";
            
            fillTimeSelect(selectedTable, today);
        });
    });

    dateInput.addEventListener('change', (e) => {
        const selectedDate = e.target.value;
        if (selectedTable) {
            fillTimeSelect(selectedTable, selectedDate);
        }
    });

    document.getElementById("closeBookingForm").addEventListener('click', () => {
        bookingContainer.style.display = "none";
    });

    bookingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const timeInput = document.getElementById("time");
        const guestsInput = document.getElementById("guests");
        const phoneInput = document.getElementById("phone");
        const messageDiv = document.getElementById("message");
        
        messageDiv.textContent = "";
        messageDiv.style.display = "none";

        const selectedDateTime = new Date(`${dateInput.value}T${timeInput.value}:00`);
        const now = new Date();
        
        if (selectedDateTime < now) {
            messageDiv.textContent = "‚ùå –ù–µ–ª—å–∑—è –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è";
            messageDiv.style.display = "block";
            return;
        }
        
        const data = {
            user_id: user_id,
            user_name: user_name,
            table: selectedTable,
            date: dateInput.value,
            time: timeInput.value,
            guests: guestsInput.value,
            phone: phoneInput.value
        };

        console.log(data);
        try {
            const res = await fetch(`${botApiUrl}/book`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (res.ok) {
                messageDiv.textContent = "‚úÖ –°—Ç–æ–ª–∏–∫ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω";
                window.Telegram.WebApp.sendData(JSON.stringify(data));
                
                setTimeout(() => {
                    bookingContainer.style.display = "none";
                }, 2000);

            } else {
                messageDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å'}`;
            }
            messageDiv.style.display = "block";
        } catch (err) {
            console.error('Fetch error:', err);
            messageDiv.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.";
            messageDiv.style.display = "block";
        }
    });
</script>
</body>
</html>