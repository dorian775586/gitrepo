<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Бронирование столов</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #f0f0f0;
            --primary-color: #b73225; /* Красный лис */
            --secondary-color: #333;
            --light-grey: #555;
            --border-radius: 8px;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Основной контейнер --- */
        .container {
            padding: 10px;
            flex-grow: 1;
        }

        /* --- Блок параметров бронирования --- */
        .booking-params {
            display: flex;
            justify-content: space-between;
            gap: 5px;
            margin-bottom: 15px;
            background: var(--secondary-color);
            padding: 10px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .param-item {
            flex: 1;
            text-align: center;
            padding: 5px 0;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .param-item:hover {
            background-color: var(--light-grey);
        }

        .param-label {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 2px;
        }

        .param-value {
            font-weight: bold;
            font-size: 14px;
            min-height: 1.2em; /* Предотвращает скачок при пустом значении */
        }

        /* --- Карточка деталей стола --- */
        #table-details-card {
            background: var(--secondary-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            display: none; /* Скрыто по умолчанию */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        #table-details-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        #table-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        #table-description {
            font-size: 14px;
            color: #ccc;
        }

        /* --- План зала --- */
        .hall-map {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 10px 0;
        }

        .table-element {
            background: var(--light-grey);
            height: 80px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
            position: relative;
            user-select: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
        }

        .table-element:active {
            transform: scale(0.98);
        }

        .table-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--text-color);
        }

        .table-seats {
            font-size: 12px;
            color: #ccc;
        }

        /* Состояния столов */
        .table-selected {
            border: 3px solid var(--primary-color);
            background: #5a2e2d; /* Темнее, чтобы показать выбор */
        }

        .table-booked {
            background: #2a2a2a;
            cursor: not-allowed;
            opacity: 0.6;
            pointer-events: none;
        }

        .table-booked::after {
            content: "ЗАНЯТО";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            color: #aaa;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 5px;
            border-radius: 3px;
        }

        /* --- Сообщение об ошибке/успехе --- */
        #message {
            margin: 15px 0;
            padding: 10px;
            border-radius: var(--border-radius);
            font-weight: bold;
            text-align: center;
            display: none;
            background-color: #5a2e2d; /* Темный фон для сообщений */
            color: var(--text-color);
        }
        #message.success {
            background-color: #387038;
        }
        #message.error {
            background-color: #b73225;
        }

        /* --- Футер и кнопка подтверждения --- */
        .footer {
            background-color: var(--secondary-color);
            padding: 10px;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.5);
            position: sticky;
            bottom: 0;
            z-index: 100;
        }

        #confirm-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
        }

        #confirm-btn:hover:not(:disabled) {
            background-color: #e04436;
        }

        #confirm-btn:disabled {
            background-color: var(--light-grey);
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* --- Модальное окно (Overlay) --- */
        #booking-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none; /* Скрыто по умолчанию */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--secondary-color);
            padding: 20px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        #closeBookingForm {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #ccc;
        }

        .modal-content input, .modal-content select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light-grey);
            border-radius: 4px;
            box-sizing: border-box;
            background-color: var(--bg-color);
            color: var(--text-color);
            appearance: none; /* Для select, чтобы убрать системные стили */
        }
        
        .modal-content select {
            /* Добавляем кастомную стрелку для select */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23f0f0f0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px;
        }

        .modal-content button[type="submit"] {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .modal-message {
             margin-top: 15px;
             padding: 10px;
             background-color: #5a2e2d;
             border-radius: 4px;
             font-size: 14px;
             text-align: center;
             display: none;
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="message"></div>

        <div class="booking-params">
            <div class="param-item" id="param-date">
                <div class="param-label">Дата</div>
                <div class="param-value" id="current-date-value"></div>
            </div>
            <div class="param-item" id="param-time">
                <div class="param-label">Время</div>
                <div class="param-value" id="current-time-value">18:00</div>
            </div>
            <div class="param-item" id="param-guests">
                <div class="param-label">Гости</div>
                <div class="param-value" id="current-guests-value">2</div>
            </div>
        </div>

        <div id="table-details-card">
            <img id="table-photo" src="" alt="Фото стола">
            <div id="table-title"></div>
            <div id="table-description"></div>
        </div>
        
        <div class="hall-map">
            <div class="table-element" id="table-1" data-table="1">
                <span class="table-number">1</span>
                <span class="table-seats">2 места</span>
            </div>
            <div class="table-element" id="table-2" data-table="2">
                <span class="table-number">2</span>
                <span class="table-seats">2 места</span>
            </div>
            <div class="table-element" id="table-3" data-table="3">
                <span class="table-number">3</span>
                <span class="table-seats">4 места</span>
            </div>
            <div class="table-element" id="table-4" data-table="4">
                <span class="table-number">4</span>
                <span class="table-seats">4 места</span>
            </div>
            <div class="table-element" id="table-5" data-table="5">
                <span class="table-number">5</span>
                <span class="table-seats">6 мест</span>
            </div>
            <div class="table-element" id="table-6" data-table="6">
                <span class="table-number">6</span>
                <span class="table-seats">8 мест</span>
            </div>
            <div class="table-element" id="table-7" data-table="7">
                <span class="table-number">7</span>
                <span class="table-seats">4 места</span>
            </div>
            <div class="table-element" id="table-8" data-table="8">
                <span class="table-number">8</span>
                <span class="table-seats">4 места</span>
            </div>
        </div>
        
    </div>

    <div class="footer">
        <button id="confirm-btn" disabled>Подтвердить бронь</button>
    </div>

    <div id="booking-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Подтверждение брони</h3>
                <button id="closeBookingForm">×</button>
            </div>
            
            <form id="booking-form">
                <div class="form-group">
                    <label>Стол:</label>
                    <span id="selected-table-modal" style="font-weight: bold; color: var(--primary-color);"></span>
                </div>
                
                <div class="form-group">
                    <label for="date-modal">Дата:</label>
                    <input type="date" id="date-modal" required>
                </div>

                <div class="form-group">
                    <label for="time-modal">Время:</label>
                    <select id="time-modal" required></select>
                </div>

                <div class="form-group">
                    <label for="guests-modal">Гостей:</label>
                    <input type="number" id="guests-modal" min="1" max="8" value="2" required>
                </div>
                
                <div class="form-group">
                    <label for="phone-modal">Телефон для связи:</label>
                    <input type="tel" id="phone-modal" placeholder="+7 (___) ___-__-__" required>
                </div>

                <button type="submit">Забронировать</button>
                <div id="modal-message" class="modal-message"></div>
            </form>
        </div>
    </div>


    <script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    // --- ДАННЫЕ О СТОЛАХ (Обновлены: единое романтическое фото для всех 8 столов) ---
const tableData = {
    '1': { 
        name: 'Столик №1 (У Бара)', 
        seats: 2, 
        desc: 'Уютный столик для двоих с видом на барную стойку. Идеально для аперитива.',
        photo_url: 'https://media.istockphoto.com/id/649672132/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%80%D0%BE%D0%BC%D0%B0%D0%BD%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%B2%D0%B5%D1%87%D0%B5%D1%80.jpg?s=612x612&w=0&k=20&c=WKNImb0RI-7oJy3RoqJhWg-VflxZI82SosEwIV1kssQ='
    },
    '2': { 
        name: 'Столик №2 (У Бара)', 
        seats: 2, 
        desc: 'Небольшой круглый стол вдали от основного зала. Идеально для свиданий.',
        photo_url: 'https://media.istockphoto.com/id/649672132/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%80%D0%BE%D0%BC%D0%B0%D0%BD%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%B2%D0%B5%D1%87%D0%B5%D1%80.jpg?s=612x612&w=0&k=20&c=WKNImb0RI-7oJy3RoqJhWg-VflxZI82SosEwIV1kssQ='
    },
    '3': { 
        name: 'Банкетка №3 (У Стены)', 
        seats: 4, 
        desc: 'Комфортный диван на четырех человек. Расположен у стены для приватности.',
        photo_url: 'https://media.istockphoto.com/id/649672132/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%80%D0%BE%D0%BC%D0%B0%D0%BD%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%B2%D0%B5%D1%87%D0%B5%D1%80.jpg?s=612x612&w=0&k=20&c=WKNImb0RI-7oJy3RoqJhWg-VflxZI82SosEwIV1kssQ='
    },
    '4': { 
        name: 'Банкетка №4 (У Стены)', 
        seats: 4, 
        desc: 'Удобная банкетка с мягкими сиденьями. Отличное место для семейного ужина.',
        photo_url: 'https://media.istockphoto.com/id/649672132/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%80%D0%BE%D0%BC%D0%B0%D0%BD%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%B2%D0%B5%D1%87%D0%B5%D1%80.jpg?s=612x612&w=0&k=20&c=WKNImb0RI-7oJy3RoqJhWg-VflxZI82SosEwIV1kssQ='
    },
    '5': { 
        name: 'Центральный Стол №5', 
        seats: 6, 
        desc: 'Большой круглый стол в центре зала. Идеален для больших компаний и торжеств.',
        photo_url: 'https://media.istockphoto.com/id/649672132/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%80%D0%BE%D0%BC%D0%B0%D0%BD%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%B2%D0%B5%D1%87%D0%B5%D1%80.jpg?s=612x612&w=0&k=20&c=WKNImb0RI-7oJy3RoqJhWg-VflxZI82SosEwIV1kssQ='
    },
    '6': { 
        name: 'Стол №6 (Квадратный)', 
        seats: 8, 
        desc: 'Самый большой стол в ресторане. Подходит для корпоративных встреч.',
        photo_url: 'https://media.istockphoto.com/id/649672132/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%80%D0%BE%D0%BC%D0%B0%D0%BD%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%B2%D0%B5%D1%87%D0%B5%D1%80.jpg?s=612x612&w=0&k=20&c=WKNImb0RI-7oJy3RoqJhWg-VflxZI82SosEwIV1kssQ='
    },
    '7': { 
        name: 'Стол №7 (У Входа)', 
        seats: 4, 
        desc: 'Прямоугольный столик, близко к входу. Хорошо для быстрого обеда.',
        photo_url: 'https://media.istockphoto.com/id/649672132/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%80%D0%BE%D0%BC%D0%B0%D0%BD%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%B2%D0%B5%D1%87%D0%B5%D1%80.jpg?s=612x612&w=0&k=20&c=WKNImb0RI-7oJy3RoqJhWg-VflxZI82SosEwIV1kssQ='
    },
    '8': { 
        name: 'Стол №8 (У Входа)', 
        seats: 4, 
        desc: 'Прямоугольный стол с хорошим обзором на входную группу.',
        photo_url: 'https://media.istockphoto.com/id/649672132/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%80%D0%BE%D0%BC%D0%B0%D0%BD%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%B2%D0%B5%D1%87%D0%B5%D1%80.jpg?s=612x612&w=0&k=20&c=WKNImb0RI-7oJy3RoqJhWg-VflxZI82SosEwIV1kssQ='
    }
};


    // --- Глобальные переменные и DOM элементы ---
    let user_id = null;
    let user_name = null;
    let botApiUrl = '';
    let selectedTable = null;
    // Новая переменная: кэш занятых времен для каждого стола на текущую дату
    let bookedTimesCache = {}; 
    
    const dateInputModal = document.getElementById("date-modal");
    const timeSelectModal = document.getElementById("time-modal");
    const guestsInputModal = document.getElementById("guests-modal");
    const phoneInputModal = document.getElementById("phone-modal");
    const confirmBtn = document.getElementById("confirm-btn");
    const bookingOverlay = document.getElementById("booking-overlay");
    const bookingForm = document.getElementById("booking-form");
    const messageDiv = document.getElementById("message");
    const modalMessageDiv = document.getElementById("modal-message");
    
    const dateValueDisplay = document.getElementById("current-date-value");
    const timeValueDisplay = document.getElementById("current-time-value");
    const guestsValueDisplay = document.getElementById("current-guests-value");

    const tableDetailsCard = document.getElementById("table-details-card");
    const tablePhoto = document.getElementById("table-photo");
    const tableTitle = document.getElementById("table-title");
    const tableDescription = document.getElementById("table-description");


    function getQueryParams() {
        const params = {};
        new URLSearchParams(window.location.search).forEach((value, key) => {
            params[key] = value;
        });
        return params;
    }

    function adaptToTheme() {
        document.documentElement.style.setProperty('color-scheme', 'dark');
    }

    window.onload = async function() {
        const params = getQueryParams();
        user_id = params.user_id;
        user_name = params.user_name;
        botApiUrl = params.bot_url || "https://readytoearn-4.onrender.com"; 

        if (window.Telegram && window.Telegram.WebApp) {
            adaptToTheme();
            window.Telegram.WebApp.ready();
        }
        
        const now = new Date();
        const todayStr = now.toISOString().slice(0, 10);
        
        dateInputModal.value = todayStr;
        dateValueDisplay.textContent = formatDateForDisplay(now);
        guestsValueDisplay.textContent = guestsInputModal.value;

        // Заполняем время и обновляем карту при загрузке
        await fetchAndCacheBookedTables(todayStr); // Загружаем все занятые времена для всех столов
        fillTimeSelect(null, todayStr); // Заполняем select без фильтрации по столу
        updateTableAvailability(todayStr, timeSelectModal.value); // Обновляем карту
    };

    function formatDateForDisplay(date) {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);

        // Нормализуем дату для сравнения
        const targetDate = new Date(date);
        targetDate.setHours(0,0,0,0);
        const todayNormalized = new Date(today);
        todayNormalized.setHours(0,0,0,0);
        const tomorrowNormalized = new Date(tomorrow);
        tomorrowNormalized.setHours(0,0,0,0);

        if (targetDate.getTime() === todayNormalized.getTime()) {
            return "Сегодня, " + newDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        } else if (targetDate.getTime() === tomorrowNormalized.getTime()) {
            return "Завтра, " + newDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        } else {
            return targetDate.toLocaleDateString('ru-RU', { weekday: 'short', day: 'numeric', month: 'short' });
        }
    }
    
    function generateAllTimeSlots() {
        const slots = [];
        let start = new Date(); start.setHours(12, 0, 0, 0); 
        const end = new Date(); end.setHours(23, 0, 0, 0); 
        while (start <= end) {
            slots.push(start.toTimeString().slice(0, 5));
            start = new Date(start.getTime() + 30 * 60000);
        }
        return slots;
    }

    /**
     * Загружает и кэширует все занятые времена для всех столов на выбранную дату.
     * @param {string} selectedDate - Дата в формате YYYY-MM-DD.
     */
    async function fetchAndCacheBookedTables(selectedDate) {
        bookedTimesCache = {}; // Очищаем кэш для новой даты
        const tableIds = Object.keys(tableData);
        const fetches = tableIds.map(tableId => {
            const url = `${botApiUrl}/get_booked_times?table=${tableId}&date=${selectedDate}`;
            return fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok') {
                        bookedTimesCache[tableId] = data.booked_times;
                    } else {
                        bookedTimesCache[tableId] = [];
                    }
                })
                .catch(error => {
                    console.error(`Ошибка при получении занятых времен для стола ${tableId}:`, error);
                    bookedTimesCache[tableId] = []; // Считаем свободными при ошибке
                });
        });
        // Устанавливаем минимальную задержку в 500 мс для предотвращения мерцания (UX)
        await Promise.all([Promise.all(fetches), new Promise(resolve => setTimeout(resolve, 500))]);
    }


    function fillTimeSelect(tableId, selectedDate) {
        const select = timeSelectModal;
        select.innerHTML = '';
        
        const allSlots = generateAllTimeSlots();
        let firstAvailableSlot = null;
        
        const now = new Date();
        const todayDateStr = now.toISOString().slice(0, 10);

        allSlots.forEach(slot => {
            // Если выбран стол, проверяем его занятость в кэше.
            // Если стол не выбран (tableId == null), слот считается свободным
            // в модальном окне выбора времени.
            let isBooked = false;
            if (tableId && bookedTimesCache[tableId]) {
                isBooked = bookedTimesCache[tableId].includes(slot);
            }
            
            let isPast = false;
            if (selectedDate === todayDateStr) {
                const [h, m] = slot.split(':').map(Number);
                const slotTime = new Date();
                slotTime.setHours(h, m, 0, 0);
                // Добавляем небольшой буфер (например, 15 минут)
                if (slotTime.getTime() <= now.getTime() + 15 * 60000) { 
                    isPast = true;
                }
            }
            
            if (!isBooked && !isPast) {
                const option = document.createElement("option");
                option.value = slot;
                option.textContent = slot;
                select.appendChild(option);
                
                if (!firstAvailableSlot) {
                    firstAvailableSlot = slot;
                }
            }
        });
        
        select.disabled = select.options.length === 0;
        if (select.options.length > 0) {
            // Выбираем первое доступное время или текущее, если оно еще есть
            const currentSelectedTime = timeValueDisplay.textContent;
            if (select.querySelector(`option[value="${currentSelectedTime}"]`)) {
                select.value = currentSelectedTime;
            } else {
                select.value = firstAvailableSlot;
            }

            timeValueDisplay.textContent = select.value;

        } else {
            timeValueDisplay.textContent = "Нет мест";
        }
    }
    
    /**
     * Обновляет визуальное состояние столов на карте
     * на основе выбранного времени и кэша занятых столов.
     * @param {string} date - Текущая дата (YYYY-MM-DD).
     * @param {string} time - Текущее время (HH:MM).
     */
    function updateTableAvailability(date, time) {
        
        document.querySelectorAll('.table-element').forEach(table => {
            table.classList.remove('table-booked', 'table-selected');
        });
        
        if (!time || time === "Нет мест") {
             document.querySelectorAll('.table-element').forEach(table => {
                 table.classList.add('table-booked'); // Блокируем все столы, если нет доступного времени
             });
             confirmBtn.disabled = true;
             confirmBtn.textContent = 'Нет свободного времени';
             
             // Сбрасываем выбор
             selectedTable = null;
             tableDetailsCard.style.display = 'none';
             return;
        }

        // 1. Блокируем столы, которые заняты на выбранное время
        Object.keys(tableData).forEach(tableId => {
            const tableElement = document.getElementById(`table-${tableId}`);
            if (tableElement) {
                 const bookedTimes = bookedTimesCache[tableId] || [];
                 if (bookedTimes.includes(time)) {
                     tableElement.classList.add('table-booked');
                 }
            }
        });

        // 2. Логика для выбранного стола
        if (selectedTable) {
            const tableElement = document.getElementById(`table-${selectedTable}`);
            if (tableElement && tableElement.classList.contains('table-booked')) {
                // Если выбранный стол оказался занят после обновления
                selectedTable = null; // Сбрасываем выбор
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Выберите другой стол';
                tableDetailsCard.style.display = 'none';
                messageDiv.textContent = '❌ Ваш стол только что заняли или изменилось время. Выберите другой стол.';
                messageDiv.style.display = 'block';
            } else if (tableElement) {
                // Если выбранный стол свободен
                tableElement.classList.add('table-selected');
                confirmBtn.disabled = false;
                confirmBtn.textContent = `Забронировать стол №${selectedTable}`;
                showTableDetails(selectedTable);
                messageDiv.style.display = 'none';
            }
        } else {
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Подтвердить бронь';
            tableDetailsCard.style.display = 'none';
            messageDiv.style.display = 'none';
        }
    }

    function showTableDetails(tableId) {
        const data = tableData[tableId];
        if (data) {
            tablePhoto.src = data.photo_url;
            tableTitle.textContent = data.name;
            tableDescription.innerHTML = `<strong>Мест:</strong> ${data.seats}<br>${data.desc}`;
            tableDetailsCard.style.display = 'block';
        }
    }

    document.querySelectorAll('.table-element').forEach(table => {
        table.addEventListener('click', (e) => {
            const clickedTable = e.currentTarget.dataset.table;
            
            if (e.currentTarget.classList.contains('table-booked')) {
                messageDiv.textContent = '❌ Столик занят. Выберите другой.';
                messageDiv.style.display = 'block';
                return;
            }
            
            if (selectedTable) {
                const prevSelected = document.getElementById(`table-${selectedTable}`);
                if (prevSelected) {
                    prevSelected.classList.remove('table-selected');
                }
            }
            
            selectedTable = clickedTable;
            e.currentTarget.classList.add('table-selected');
            confirmBtn.disabled = false;
            confirmBtn.textContent = `Забронировать стол №${selectedTable}`;
            messageDiv.style.display = 'none';

            showTableDetails(selectedTable);
        });
    });

    // Обработка клика по параметрам вверху
    document.getElementById('param-date').addEventListener('click', () => {
        // Имитация клика на скрытый input date в модальном окне
        dateInputModal.focus();
        dateInputModal.click(); 
    });
    
    document.getElementById('param-time').addEventListener('click', () => {
        // Имитация клика на скрытый select time в модальном окне
        timeSelectModal.focus();
        timeSelectModal.click(); 
    });
    
    document.getElementById('param-guests').addEventListener('click', () => {
        // Имитация клика на скрытый input guests в модальном окне
        guestsInputModal.focus();
        guestsInputModal.click(); 
    });


    confirmBtn.addEventListener('click', () => {
        if (!selectedTable) return;
        
        document.getElementById('selected-table-modal').textContent = selectedTable;
        // Перезаполняем время с фильтром по выбранному столу
        fillTimeSelect(selectedTable, dateInputModal.value); 

        // Обновляем текущее отображение времени в модалке (на случай, если его изменили в основном UI)
        if (timeSelectModal.querySelector(`option[value="${timeValueDisplay.textContent}"]`)) {
            timeSelectModal.value = timeValueDisplay.textContent;
        } else {
            // Если выбранное ранее время занято/недоступно, берем первое из select
            timeSelectModal.value = timeSelectModal.options[0] ? timeSelectModal.options[0].value : '';
        }

        phoneInputModal.value = ''; 
        modalMessageDiv.style.display = 'none';
        bookingOverlay.style.display = 'flex';
    });

    document.getElementById("closeBookingForm").addEventListener('click', () => {
        bookingOverlay.style.display = 'none';
    });

    dateInputModal.addEventListener('change', async (e) => {
        const newDate = new Date(e.target.value);
        dateValueDisplay.textContent = formatDateForDisplay(newDate);
        // Запускаем асинхронную загрузку нового кэша
        await fetchAndCacheBookedTables(e.target.value); 
        // Обновляем select времени, используя новый кэш
        fillTimeSelect(selectedTable, e.target.value); 
        // Обновляем карту
        updateTableAvailability(e.target.value, timeValueDisplay.textContent); 
    });
    
    timeSelectModal.addEventListener('change', (e) => {
        // Обновляем отображение времени в главном UI
        timeValueDisplay.textContent = e.target.value; 
        // Обновляем карту
        updateTableAvailability(dateInputModal.value, e.target.value); 
    });

    guestsInputModal.addEventListener('change', (e) => {
        guestsValueDisplay.textContent = e.target.value;
    });


    bookingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        modalMessageDiv.textContent = "";
        modalMessageDiv.style.display = "none";
        
        const selectedDateTime = new Date(`${dateInputModal.value}T${timeSelectModal.value}:00`);
        const now = new Date();
        
        if (selectedDateTime.getTime() <= now.getTime() + 15 * 60000) { // Проверка с 15-минутным буфером
            modalMessageDiv.textContent = "❌ Нельзя забронировать на прошедшее время";
            modalMessageDiv.style.display = "block";
            return;
        }

        if (!phoneInputModal.value || phoneInputModal.value.length < 5) {
             modalMessageDiv.textContent = "❌ Укажите корректный телефон.";
             modalMessageDiv.style.display = "block";
             return;
        }
        
        const data = {
            user_id: user_id,
            user_name: user_name,
            table: selectedTable,
            date: dateInputModal.value,
            time: timeSelectModal.value,
            guests: guestsInputModal.value,
            phone: phoneInputModal.value
        };

        try {
            const res = await fetch(`${botApiUrl}/book`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            
            if (res.ok) {
                modalMessageDiv.textContent = "✅ Столик забронирован! Ищем подтверждение в Telegram.";
                modalMessageDiv.classList.add("success");
                modalMessageDiv.style.display = "block";
                
                // ОБНОВЛЕНИЕ КЭША И UI ПОСЛЕ УСПЕШНОГО БРОНИРОВАНИЯ
                // 1. Добавляем только что забронированное время в кэш
                if (!bookedTimesCache[selectedTable]) {
                     bookedTimesCache[selectedTable] = [];
                }
                bookedTimesCache[selectedTable].push(timeSelectModal.value);

                setTimeout(() => {
                    bookingOverlay.style.display = "none";
                    // Сбрасываем выбранный стол
                    const tableElement = document.getElementById(`table-${selectedTable}`);
                    if (tableElement) {
                        tableElement.classList.remove('table-selected');
                    }
                    selectedTable = null;
                    
                    // 2. Визуально обновляем карту, чтобы показать стол занятым
                    updateTableAvailability(dateInputModal.value, timeValueDisplay.textContent);

                    messageDiv.textContent = "✅ Столик забронирован! Проверьте Telegram для деталей.";
                    messageDiv.style.display = 'block';

                    // Отправка данных в бота (если нужно закрыть WebApp)
                    // window.Telegram.WebApp.sendData(JSON.stringify(data));
                    // window.Telegram.WebApp.close(); 
                }, 2000);

            } else {
                modalMessageDiv.textContent = `❌ Ошибка: ${result.message || 'Не удалось забронировать'}`;
                modalMessageDiv.classList.remove("success");
                modalMessageDiv.style.display = "block";
            }
        } catch (err) {
            console.error('Fetch error:', err);
            modalMessageDiv.textContent = "❌ Ошибка сети. Проверьте подключение.";
            modalMessageDiv.classList.remove("success");
            modalMessageDiv.style.display = "block";
        }
    });
</script>
</body>
</html>